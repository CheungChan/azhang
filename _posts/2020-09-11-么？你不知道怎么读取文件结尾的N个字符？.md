---
title: 什么？你不知道怎么读取文件结尾的N个字符？
key: read_last_n_charactors
layout: article
date: '2020-09-11 12:30:00'
tags: 技术 python
typora-root-url: ../../iblog

---

### 前言

话说有这么个事，有个日志文件很大，需要在前端展示后N个字符，类似于linux的tail命令。一开始文件是用aiofiles读的，读取后10000个字符，后来有时候发现会报错`MemoryError` ，后来查了一下发现aiofiles并不是真正的异步，只是开了另一个线程去阻塞另一个线程读文件，因为epoll不支持本地io，操作系统读取本地文件只有阻塞的一种。所以最后就放弃了aiofiles的方案。使用seek先定位到文件末尾，再seek一下定位到当前位置减去N，然后读取即可。

#### 代码

```python
    def read_last_n_of_file(self, file_name, max_len):
        with open(file_name, "r", encoding="utf-8") as f:
            f.seek(0, 2)
            # seek to end of file; f.seek(0, os.SEEK_END) is legal
            f.seek(f.tell() - max_len, 0)
            # seek to the max_len last char of file;
            # while f.seek(f.tell()-max_len, os.SEEK_SET) is legal,
            # f.seek(-maxlen, 0) will throw an error.
            new_message = f.read()
            return new_message
```

附上seek的用法解析

```
file.seek(offset,position)
```

1. `offset`: How many characters you need (i.e. 1 means one character)

2. ```
   position
   ```

   : Tell where your file read/write operation should start .

   - 0 means starting of file
   - 1 means current position of file read/write cursor
   - 2 means end of file

`f.seek(f.tell()-1,2)` means go to the end of file and traverse back one element

`print f.read()` prints the value obtained from the seek command